<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <!-- https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP -->


    <title>Broadcaster</title>
    <link rel = "stylesheet" href="css/gtk4web.css">
    <link rel = "stylesheet" href="css/fonts.css">
    <link rel = "stylesheet" href="css/style.css">
    <script src = "js/anime.min.js"></script>
    <link rel = "icon" href="img/icon1024.png">

    <link rel = "stylesheet" href = "css/materialize.min.css">
    <link rel = "stylesheet" href = "css/broadcaster_style.css">
    <script src="js/communicator.js"></script>
    <link rel="stylesheet" type="text/css" href="css/popr.css">
    <script>window.$ = window.jQuery = require('./js/jquery-3.7.1.min.js');</script>

</head>
<body>

<div class = "gtk-window main-window" style="">
    <div class = "gtkheader">
        <div></div>
        <div style="width: -webkit-fit-avalible; text-align: center">
            <div class = "tittle" style="padding-top: 2px !important; padding: 0; ">Донати</div>
        </div>
        <div class="close">
            <img class = "close_icon" src="symbols/close.svg">
        </div>
    </div>
    <div class = "content scrollbar" style="margin: 0; overflow-y: scroll">
        <div class="frame col s12" style=" margin-top: 0.5em;  padding: 0; height: 100%">



                        <div class="input-field col s12">
                            <form class="input-field-form">
                                <div>
                                <label class = "input-label" for="disabled">Ваш токен для Вебгуків</label>

                                <input id = "token" class = "input-row" disabled value="I am not editable" id="disabled" type="text" class="validate">
                                </div>
                                <img src="symbols/copy-symbolic.svg" class="highlight_icon copy" style="
    height: 1.5rem;
">
                            </form>
                        </div>
            <div class = "preferences-group" style="gap: 1em">
                <div class = 'preferences_header'><div class = "caption"><div class = "preferences_caption">Найбільший донат</div> <div class="preferences_subcaption" >Цей донат найбільший</div>

                </div></div>
            <ul class="collapsible not-show">


            </ul>
            </div>
            <div class = "preferences-group" style="gap: 1em">
                <div class = 'preferences_header'><div class = "caption"><div class = "preferences_caption">Усі донати</div> <div class="preferences_subcaption" >Решта не менш важливі</div>

                </div></div>
                <ul class="collapsible not-show">


                </ul>
            </div>

            <div class="donate-window">
                <img src="symbols/donut.svg" style="filter: invert(30%) sepia(90%) saturate(10%) hue-rotate(60deg) brightness(50%) contrast(120%)">
               <p style="color: #656764ff"> Тут будуть відображені ваші донати</p>
            </div>
</div>

</div>
</div>
<script src = "js/broadcaster.js"></script>
<script src="js/gtk4web.js"></script>
<script type="module" src = "gtk.js"></script>
<script type = "module" src = "theme.js"></script>
<script src = "js/coockie.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/@gradio/client@0.1.4/dist/index.min.js"></script>
<script src="js/materialize.min.js"></script>

<script>
    if (document.getElementsByClassName("collapsible")[0].childElementCount === 0){
        document.getElementsByClassName("preferences-group")[0].classList.add("not-show");
        document.getElementsByClassName("preferences-group")[1].classList.add("not-show");
        document.getElementsByClassName("collapsible")[0].classList.remove("not-show");

        document.getElementsByClassName("collapsible")[1].classList.remove("not-show");
    }
    document.getElementById("token").value = localStorage.getItem("token");
    document.addEventListener('DOMContentLoaded', function () {
        var elems = document.querySelectorAll('.collapsible');
        var instances = M.Collapsible.init(elems, {
            accordion: false
        });
    });
    wc.postMessage("get_donates");
    wc.addEventListener("message", (e) =>{
        console.log(e.data);
        amount = [];
         let obj = JSON.parse(decodeURI(e.data.replaceAll("+", " ").replaceAll("%2C", ",").replaceAll("%3B", ";").replaceAll("%3A", ":")));
    
        obj.forEach((e) =>  {create_donate(e, 1); amount[document.getElementsByClassName("collapsible")[1].childElementCount - 1] = Number(e.amount)});
       cleare_max();
       if (obj.length > 0){
        document.getElementsByClassName("preferences-group")[1].classList.remove("not-show");
        document.getElementsByClassName("preferences-group")[0].classList.remove("not-show");
        create_donate(obj[obj.findIndex((index) =>
           Number(index.amount) === Math.max(...amount))], 0);
       donate = obj;
       }




    });
    bc.addEventListener("message", (e) => {
        let amount = [];
        console.log(e.data);
        let obj = JSON.parse(decodeURI(e.data.replaceAll("+", " ").replaceAll("%2C", ",").replaceAll("%3B", ";").replaceAll("%3A", ":")));
       donate[donate.length] = obj;
       donate.forEach((index) => amount[amount.length] = Number(index.amount));
        create_donate(obj, 1);
        cleare_max();
        create_donate(donate[donate.findIndex((index) =>
            Number(index.amount) === Math.max(...amount))], 0);



    })
    document.getElementsByClassName("copy")[0].addEventListener("click", copy_token);
    document.getElementById("token").addEventListener("click", copy_token);
    function copy_token(){
        let copy = document.getElementById("token").value;
        ipc.send("copy", copy);
    }
    let backgrounds = [
        "linear-gradient(291deg, #178854 0%, #54cc59 45%, #53b784 100%)", "linear-gradient(287deg, #8a2995 0%, #f5576c 100%)", "linear-gradient(170deg, #6a11cb 0%, #2575fc 100%)",   "linear-gradient(204deg, #eea2a2 0%, #bbc1bf 19%, #57c6e1 42%, #b49fda 79%, #7ac5d8 100%)", "linear-gradient(190deg, #f43b47 0%, #453a94 100%)", "linear-gradient(5deg, #505285 0%, #585e92 12%, #65689f 25%, #7474b0 37%, #7e7ebb 50%, #8389c7 62%, #9795d4 75%, #a2a1dc 87%, #b5aee4 100%)", "linear-gradient(15deg, #13547a 0%, #80d0c7 100%)", "linear-gradient(204deg, #ffd166 0%, #ff7767 48%, #ff326d 100%)", "linear-gradient(325deg, #005d46 0%, #c64cff 20%, #b9b0ff 100%)"
    ]
    function cleare_max(){
        document.getElementsByClassName("collapsible")[0].innerHTML = "";
    }
    function create_donate(obj, id){
        if (document.getElementsByClassName("collapsible")[0].childElementCount === 0){
            document.getElementsByClassName("donate-window")[0].classList.add("not-show");
            document.getElementsByClassName("preferences-group")[1].classList.remove("not-show");
            document.getElementsByClassName("preferences-group")[0].classList.remove("not-show");

            document.getElementsByClassName("collapsible")[0].classList.remove("not-show");
            document.getElementsByClassName("collapsible")[1].classList.remove("not-show");

        }
        let li = document.createElement("li");
        li.classList.add("collapsible-el");
        let header = document.createElement("div");
        header.classList.add("collapsible-header");
        let name = document.createElement("div");
        name.innerText = obj.name;
        let amount = document.createElement("span");
        amount.classList.add("badge");
        amount.innerText = obj.amount + " ₴";
        header.appendChild(name);
        header.appendChild(amount);
        li.appendChild(header);
        let body = document.createElement("div");
        body.classList.add("collapsible-body");
        let message = document.createElement("div");
        message.classList.add("collapsible-text");
        message.innerText = obj.message;
        let time = document.createElement("p");
        time.classList.add("collapsible-time");
        time.innerText = obj.datetime.split(" @ ")[1].split(":")[0] + ":" + obj.datetime.split(" @ ")[1].split(":")[1];
        body.appendChild(message);
        body.appendChild(time);
        li.appendChild(body);
        document.getElementsByClassName("collapsible")[id].insertBefore(li, document.getElementsByClassName("collapsible")[id].firstChild);

       amount.style.background = backgrounds[Math.floor(Math.random()*backgrounds.length)];
       // amount.style.color = "red";

    }
</script>

</body>
</html>


