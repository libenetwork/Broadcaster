<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <!-- https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP -->


    <title>Broadcaster</title>
    <link rel = "stylesheet" href="css/gtk4web.css">
    <link rel = "stylesheet" href="css/fonts.css">
    <link rel = "stylesheet" href="css/style.css">
    <script src = "js/anime.min.js"></script>
    <link rel = "icon" href="img/icon1024.png">
    <link rel = "stylesheet" href = "css/materialize.min.css">
    <link rel = "stylesheet" href = "css/broadcaster_style.css">
    <script src="js/communicator.js"></script>

</head>
<body>

<div class = "gtk-window main-window" style="">
    <div class = "gtkheader">

        <img class = "add_icon" src="symbols/plus-large-square-outline-symbolic.svg">
        <div>
            <div class="tab active"><img class="tab_icon" src="symbols/skull-symbolic.svg">Сцена 1</div>
        </div>
        <div class="close">
            <img class = "close_icon" src="symbols/close.svg">
        </div>
    </div>
    <div class = "content row" style="margin: 0;">
        <div class="frame col s12 m12 l9 xl7" style=" margin-top: 0.5em;  padding: 0; height: 100%">
           <div class="video-container">
               <div class = "no-video"><img src="symbols/eye-not-looking-symbolic.svg" class = "disactive_icon" style ="height: 7vh">
               </div> <div class="no-video"> <p class="no-sources-text">Відкрийте сцену, аби почати трансляцію</p></div>

            <video id="video" style = "width: 100%; height: 100%; object-fit: fill" class="not-show" autoplay playsinline muted style="
"></video></div>
            <div class="button_row">
                <div class = "gtkbutton" id = "open_scene"><img class="button_icon"  src="symbols/explore2-large-symbolic.svg">Відкрити сцену</div>
                <div class = "gtkbutton"><img class="button_icon" src="symbols/podcast-symbolic.svg">Почати трансляції</div>
                <div class = "gtkbutton"><img src="symbols/donut.svg">Пожертви</div>
                <div class = "gtkbutton live-button"><img class="button_icon" src="symbols/media-record-symbolic.svg">Вийти в етер!</div>
            </div>

            <div class="button_row" id = "comments">
                <div class = "gtkbutton" ><img style="width: 15pt" src="symbols/chat-bubbles-empty-inverted-symbolic.png">Подивитися коментарі</div>

            </div>
            <div class="audio_sources">
                <div class = "preferences-group">
                    <div class = 'preferences_header'><div class = "caption"><div class = "preferences_caption">Авдіо джерела</div><div class="preferences_subcaption">Додайте джерело авдіо, що мусить бути в трансляції</div> </div>
                        <div class = "preferences_sufix"><img class = "sufix_icon button_icon" src="symbols/plus-large-symbolic.svg">Додайте джерела</div></div>
                    <div class = "no-sources">
                        <img class = 'disactive_icon no-source-icon' src = "symbols/sound-wave-alt-symbolic.svg">
                        <div class = "no-sources-text">Нема звуку. Без звуку неможливо почати трансляцію</div>
                    </div>
                    <div id = "source" class="not-show audio_sources preferences-group-body no-scrollbar">

                    </div>
                </div>
            </div>
    </div>



</div>

</div>
<script src = "js/broadcaster.js"></script>
<script src = "js/youtube_auth.js"></script>
<script src="js/gtk4web.js"></script>
<script type="module" src = "gtk.js"></script>
<script type = "module" src = "theme.js"></script>

<script src = "js/communicator.js"></script>
<script src = "js/coockie.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/@gradio/client@0.1.4/dist/index.min.js"></script>
<script src = "js/audio.js"></script>
<script src="js/donate.js"></script>
<script src="js/generate.js" type="module"></script>
<script src = "js/sources.js"></script>
<script src = "js/grab.js"></script>
<script>
    function em2px(em) {
        return Number(em) * Number(window.getComputedStyle(document.body).getPropertyValue('font-size').match(/\d+/)[0]);
    }
    onresize = (e) => {
        let elem = document.getElementById("source");

        elem.style.maxHeight = window.innerHeight - elem.offsetTop - em2px(1) + "px";

    };
    wc.addEventListener("message", (e) =>
    {

        switch (e.data){
            case "connected":
                alert("Поширте вікно створенної сцени");

                ipc.send("get-frame");
                ipc.on("frame_id", async (e, source) => {
                    try {

                        let stream = await navigator.mediaDevices.getUserMedia({
                            audio: {
                                mandatory: {
                                    chromeMediaSource: 'desktop'
                                }
                            },
                            video: {
                                mandatory: {
                                    chromeMediaSource: 'desktop',
                                    chromeMediaSourceId: source,


                                }
                            }
                        });
                        let delete_elem = document.getElementsByClassName("no-video");
                        for (let i = 0; i < delete_elem.length; i++){
                            delete_elem[i].style.display = "none";
                        }
                        let container = document.createElement("div");
                        document.getElementById("video").classList.remove("not-show");
                        document.getElementById("video").srcObject = stream;
                        document.getElementsByClassName("no-sources")[0].classList.add("not-show");
                        let system_sound = document.createElement("div");
                        let system_icon = document.createElement("img");
                        system_icon.src = "symbols/audio-volume-high-symbolic.svg";
                        system_icon.classList.add("button_icon");
                        system_sound.appendChild(system_icon);
                        let place_source = document.getElementsByClassName("audio_sources")[1];
                        place_source.classList.remove("not-show");
                        let system_text = document.createElement("div");
                        system_text.innerText = "Захоплення пристрою";
                        system_text.style.fontWeight = "300";
                        system_sound.appendChild(system_text);
                        container.classList.add('preferences-group-element');
                        system_sound.classList.add('audio-source-tittle');


                        container.appendChild(system_sound);
                       // place_source.appendChild(system_sound);
                        let elem = document.getElementById("source");
                        (function(timer) {


                                elem.addEventListener('scroll', function(e) {

                                        elem.classList.remove('no-scrollbar');
                                    elem.classList.add('scrollbar');

                                    clearTimeout(timer);
                                        timer = setTimeout(function() {
                                            elem.classList.add('no-scrollbar');
                                            elem.classList.remove('scrollbar');
                                        }, 100);

                                })

                        })();
                        elem.style.maxHeight = window.innerHeight - elem.offsetTop - em2px(1) + "px";
                        let system_range = document.createElement("input");
                        system_range.type = "range";
                        system_range.name = "system_volume";
                        let id = place_source.childElementCount / 2;
                        system_range.id = "volume" + id;
                        system_range.min = "0";
                        system_range.max = '100';
                        system_range.classList.add("range_input");
                        let system_indicator = document.createElement("div");
                        system_indicator.classList.add("indicator_body");
                        let system_progress = document.createElement("div");
                        system_progress.classList.add("indicator");
                        system_indicator.appendChild(system_progress);

                        const tempSliderValue = system_range.value;

                        const progress = (tempSliderValue / system_range.max) * 100;

                        system_range.style.background = `linear-gradient(to right, #3584e4 ${progress}%,  #6d6d6dff ${progress}%)`;

                        system_range.addEventListener("input", (event) => {
                            const tempSliderValue = event.target.value;

                            const progress = (tempSliderValue / system_range.max) * 100;

                            system_range.style.background = `linear-gradient(to right, #3584e4 ${progress}%,  #6d6d6dff ${progress}%)`;
                        })
                        container.appendChild(system_range);
                        place_source.appendChild(container);
                        system_progress.id = "indicator" + id;
                        place_source.appendChild(system_indicator);
                        create_streame_from_track(stream.getAudioTracks()[0], id);


                        // wc.postMessage("connected")
                    }catch (e){
                        console.log(e);
                    }



                });
                break;
        }
    });
</script>
</body>
</html>


